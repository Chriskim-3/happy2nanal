<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy2Nanal</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div id="leftSidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav('left')">×</a>
        <a href="#" onclick="showContent('이 홈페이지는 글도 쓰고, 이것저것 올리고, 맘대로 지울려고 만드는 사이트 입니다.')">홈페이지 소개</a>
        <a href="#" onclick="showStudyList('JavaScript')">JavaScript 공부</a>
        <a href="#" onclick="showStudyList('Python')">Python 공부</a>
    </div>

    <div id="rightSidebar" class="sidebar right">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav('right')">×</a>
        <a href="#" onclick="showQnAList()">Q&A</a>
        <a href="#" onclick="showNoticeList()">공지사항</a>
        <a href="#" onclick="showFileList()">자료실</a>
    </div>

    <div id="main">
        <button class="openbtn left" onclick="openNav('left')">☰</button>
        <button class="openbtn right" onclick="openNav('right')">☰</button>
        
        <div class="header">
            <div class="support-message">당신의 칼퇴를 응원합니다</div>
            <div class="main-title">Happy2Nanal</div>
        </div>
        
        <div id="mainContent" class="content">
            <div class="main">
                <div id="footer-image">
                    <img src="beach_img.webp" alt="Footer Image">
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        ©happy2nanal. All Rights Reserved.
    </div>

    <!-- 비밀번호 입력 모달 -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">비밀번호 입력</h2>
            <input type="password" id="passwordInput" placeholder="비밀번호를 입력하세요">
            <button onclick="submitPassword()">확인</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Firebase 구성
        const firebaseConfig = {
            // Your Firebase configuration here
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 글 제출 함수들
        window.submitStudy = function(event, password) {
            event.preventDefault();
            const title = document.getElementById('studyTitle').value;
            const content = document.getElementById('studyContent').value;
            const newStudyRef = push(ref(db, 'studies'));
            set(newStudyRef, {
                title: title,
                content: content,
                password: password,
                timestamp: Date.now()
            }).then(() => {
                alert('학습 글이 저장되었습니다.');
                showStudyList('JavaScript'); // 또는 적절한 주제로 변경
            }).catch((error) => {
                console.error("Error writing document: ", error);
            });
        }

        window.submitQnA = function(event, password) {
            event.preventDefault();
            const title = document.getElementById('qnaTitle').value;
            const content = document.getElementById('qnaContent').value;
            const newQnARef = push(ref(db, 'qna'));
            set(newQnARef, {
                title: title,
                content: content,
                password: password,
                timestamp: Date.now()
            }).then(() => {
                alert('Q&A가 저장되었습니다.');
                showQnAList();
            }).catch((error) => {
                console.error("Error writing document: ", error);
            });
        }

        window.submitNotice = function(event, password) {
            event.preventDefault();
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const newNoticeRef = push(ref(db, 'notices'));
            set(newNoticeRef, {
                title: title,
                content: content,
                password: password,
                timestamp: Date.now()
            }).then(() => {
                alert('공지사항이 저장되었습니다.');
                showNoticeList();
            }).catch((error) => {
                console.error("Error writing document: ", error);
            });
        }

        window.submitFile = function(event, password) {
            event.preventDefault();
            const title = document.getElementById('fileTitle').value;
            const file = document.getElementById('fileUpload').files[0];
            // 실제 파일 업로드 로직은 별도로 구현해야 합니다.
            // 여기서는 파일 정보만 저장합니다.
            const newFileRef = push(ref(db, 'files'));
            set(newFileRef, {
                title: title,
                fileName: file.name,
                password: password,
                timestamp: Date.now()
            }).then(() => {
                alert('파일 정보가 저장되었습니다.');
                showFileList();
            }).catch((error) => {
                console.error("Error writing document: ", error);
            });
        }

        // 글 목록 표시 함수들
        window.showStudyList = function(subject) {
            const studiesRef = ref(db, 'studies');
            get(studiesRef).then((snapshot) => {
                let html = `<h2>${subject} 학습 목록</h2><ul>`;
                snapshot.forEach((childSnapshot) => {
                    const study = childSnapshot.val();
                    html += `<li onclick="showStudyDetail('${childSnapshot.key}')">
                                ${study.title}
                             </li>`;
                });
                html += '</ul>';
                html += '<button onclick="showPasswordModal(\'study\')">새 글 작성</button>';
                document.getElementById('mainContent').innerHTML = html;
            });
        }

        window.showQnAList = function() {
            const qnaRef = ref(db, 'qna');
            get(qnaRef).then((snapshot) => {
                let html = '<h2>Q&A 목록</h2><ul>';
                snapshot.forEach((childSnapshot) => {
                    const qna = childSnapshot.val();
                    html += `<li onclick="showQnADetail('${childSnapshot.key}')">
                                ${qna.title}
                             </li>`;
                });
                html += '</ul>';
                html += '<button onclick="showPasswordModal(\'qna\')">새 Q&A 작성</button>';
                document.getElementById('mainContent').innerHTML = html;
            });
        }

        window.showNoticeList = function() {
            const noticesRef = ref(db, 'notices');
            get(noticesRef).then((snapshot) => {
                let html = '<h2>공지사항 목록</h2><ul>';
                snapshot.forEach((childSnapshot) => {
                    const notice = childSnapshot.val();
                    html += `<li onclick="showNoticeDetail('${childSnapshot.key}')">
                                ${notice.title}
                             </li>`;
                });
                html += '</ul>';
                html += '<button onclick="showPasswordModal(\'notice\')">새 공지사항 작성</button>';
                document.getElementById('mainContent').innerHTML = html;
            });
        }

        window.showFileList = function() {
            const filesRef = ref(db, 'files');
            get(filesRef).then((snapshot) => {
                let html = '<h2>자료실</h2><ul>';
                snapshot.forEach((childSnapshot) => {
                    const file = childSnapshot.val();
                    html += `<li onclick="showFileDetail('${childSnapshot.key}')">
                                ${file.title}
                             </li>`;
                });
                html += '</ul>';
                html += '<button onclick="showPasswordModal(\'file\')">새 파일 업로드</button>';
                document.getElementById('mainContent').innerHTML = html;
            });
        }

        // 글 상세 보기 및 수정/삭제 함수들
        window.showStudyDetail = function(key) {
            const studyRef = ref(db, `studies/${key}`);
            get(studyRef).then((snapshot) => {
                const study = snapshot.val();
                let html = `
                    <h2>${study.title}</h2>
                    <p>${study.content}</p>
                    <button onclick="editStudy('${key}')">수정</button>
                    <button onclick="deleteStudy('${key}')">삭제</button>
                `;
                document.getElementById('mainContent').innerHTML = html;
            });
        }

        window.editStudy = function(key) {
            showPasswordModal('editStudy', key);
        }

        window.deleteStudy = function(key) {
            showPasswordModal('deleteStudy', key);
        }

        // QnA, Notice, File에 대해서도 유사한 함수들을 구현합니다.

        // 비밀번호 확인 및 수정/삭제 처리
        window.submitPassword = function() {
            const password = document.getElementById('passwordInput').value;
            const [action, key] = currentAction.split(':');
            
            if (action.startsWith('edit') || action.startsWith('delete')) {
                const contentType = action.replace('edit', '').replace('delete', '').toLowerCase();
                const contentRef = ref(db, `${contentType}s/${key}`);
                
                get(contentRef).then((snapshot) => {
                    const content = snapshot.val();
                    if (content.password === password) {
                        if (action.startsWith('edit')) {
                            showEditForm(contentType, key, content);
                        } else if (action.startsWith('delete')) {
                            deleteContent(contentType, key);
                        }
                    } else {
                        alert('비밀번호가 일치하지 않습니다.');
                    }
                });
            } else {
                // 새 글 작성 로직 (이전과 동일)
            }

            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        function showEditForm(contentType, key, content) {
            let html = `
                <h2>${contentType} 수정</h2>
                <form onsubmit="updateContent(event, '${contentType}', '${key}')">
                    <input type="text" id="editTitle" value="${content.title}" required>
                    <textarea id="editContent" required>${content.content}</textarea>
                    <button type="submit">수정</button>
                </form>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        window.updateContent = function(event, contentType, key) {
            event.preventDefault();
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;
            const contentRef = ref(db, `${contentType}s/${key}`);
            
            set(contentRef, {
                title: title,
                content: content,
                password: content.password,  // 기존 비밀번호 유지
                timestamp: Date.now()
            }).then(() => {
                alert(`${contentType}가 수정되었습니다.`);
                window[`show${contentType.charAt(0).toUpperCase() + contentType.slice(1)}List`]();
            }).catch((error) => {
                console.error("Error updating document: ", error);
            });
        }

        function deleteContent(contentType, key) {
            const contentRef = ref(db, `${contentType}s/${key}`);
            remove(contentRef).then(() => {
                alert(`${contentType}가 삭제되었습니다.`);
                window[`show${contentType.charAt(0).toUpperCase() + contentType.slice(1)}List`]();
            }).catch((error) => {
                console.error("Error removing document: ", error);
            });
        }

        // Firebase 초기화 후 전역 스코프에 함수들을 할당
        window.db = db;

        // 네비게이션 함수들
        window.openNav = function(side) {
            document.getElementById(side + "Sidebar").style.width = "250px";
            document.getElementById("main").style.marginLeft = side === 'left' ? "250px" : "0";
            document.getElementById("main").style.marginRight = side === 'right' ? "250px" : "0";
        }

        window.closeNav = function(side) {
            document.getElementById(side + "Sidebar").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
            document.getElementById("main").style.marginRight = "0";
        }

        window.showContent = function(content) {
            document.getElementById('mainContent').innerHTML = `<p>${content}</p>`;
        }

        window.showPasswordModal = function(action, key = '') {
            currentAction = key ? `${action}:${key}` : action;
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('modalTitle').innerText = `비밀번호 입력 (${action})`;
        }

        // 모달 닫기
        document.querySelector('.close').onclick = function() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('passwordModal')) {
                document.getElementById('passwordModal').style.display = 'none';
            }
        }

        let currentAction = '';
    </script>
</body>
</html>
